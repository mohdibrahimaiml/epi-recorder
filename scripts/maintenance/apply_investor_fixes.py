import json
import sys
sys.stdout.reconfigure(encoding='utf-8')

NB_PATH = r"c:\Users\dell\epi-recorder\epi_investor_demo_ULTIMATE.ipynb"

with open(NB_PATH, 'r', encoding='utf-8') as f:
    nb = json.load(f)

print("üîß Applying investor feedback fixes...")

# ===== FIX 1: INSTALL CELL (subprocess.check_call) =====
install_source = [
    "# @title üöÄ Install & Setup (v2.1.1 Enforced) { display-mode: \"form\" }\n",
    "import sys\n",
    "import time\n",
    "import subprocess\n",
    "from IPython.display import clear_output, display, HTML\n",
    "\n",
    "REQUIRED_VERSION = \"2.1.1\"\n",
    "\n",
    "print(f\"üöÄ Installing EPI Recorder v{REQUIRED_VERSION}...\")\n",
    "\n",
    "start = time.time()\n",
    "\n",
    "# 1. Force a clean install to avoid caching issues\n",
    "try:\n",
    "    subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", \"--upgrade\", \"pip\"])\n",
    "    subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", \"pandas\"])\n",
    "    # Force reinstall to catch the latest PyPI release\n",
    "    subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"-q\", \"--force-reinstall\", \"epi-recorder\"])\n",
    "except subprocess.CalledProcessError as e:\n",
    "    print(f\"‚ùå Install failed: {e}\")\n",
    "    sys.exit(1)\n",
    "\n",
    "# 2. Verify Version\n",
    "try:\n",
    "    result = subprocess.run([\"epi\", \"version\"], capture_output=True, text=True, timeout=5)\n",
    "    version_output = result.stdout.strip()\n",
    "except Exception:\n",
    "    version_output = \"Unknown\"\n",
    "\n",
    "clear_output()\n",
    "\n",
    "# 3. Display Status\n",
    "if REQUIRED_VERSION in version_output:\n",
    "    display(HTML(f'<h1 style=\"color: #10b981;\">‚úÖ EPI Recorder v{REQUIRED_VERSION} Ready</h1>'))\n",
    "    print(f\"‚è±Ô∏è  Setup Time: {time.time() - start:.1f}s\")\n",
    "    print(f\"üì¶ Source: PyPI (Official Release)\")\n",
    "    print(\"=\"*70)\n",
    "else:\n",
    "    display(HTML(f'<h1 style=\"color: #f59e0b;\">‚ö†Ô∏è Version Mismatch</h1>'))\n",
    "    print(f\"Expected: {REQUIRED_VERSION}\")\n",
    "    print(f\"Installed: {version_output}\")\n",
    "    print(\"Continuing (compatibility likely)...\")\n"
]

# ===== FIX 2: RECORD CELL (subprocess.run, no timeout command) =====
record_source = [
    "# @title üé¨ Record & Download { display-mode: \"form\" }\n",
    "import time\n",
    "import os\n",
    "import subprocess\n",
    "from pathlib import Path\n",
    "from IPython.display import display, HTML\n",
    "\n",
    "display(HTML('<h1 style=\"color: #3b82f6;\">üé¨ RECORDING...</h1>'))\n",
    "\n",
    "# 1. Clean slate\n",
    "!rm -rf epi-recordings/*.epi 2>/dev/null\n",
    "!rm -f *.epi 2>/dev/null\n",
    "\n",
    "print(\"üìπ Capturing AI execution (Cryptographic Signing Active)...\")\n",
    "start_time = time.time()\n",
    "\n",
    "# 2. Run with Subprocess (Safer than ! magic)\n",
    "try:\n",
    "    # We use 'python -u' to unbuffer stdout so EPI catches it all\n",
    "    cmd = [\"epi\", \"run\", \"python3 -u trading_agent.py\", \"--no-open\"]\n",
    "    \n",
    "    result = subprocess.run(\n",
    "        cmd, \n",
    "        capture_output=True, \n",
    "        text=True, \n",
    "        timeout=45  # Safety limit\n",
    "    )\n",
    "    \n",
    "    # Check for CLI errors\n",
    "    if result.returncode != 0:\n",
    "        print(\"‚ö†Ô∏è Warning during recording:\")\n",
    "        print(result.stderr)\n",
    "\n",
    "except subprocess.TimeoutExpired:\n",
    "    print(\"‚ö†Ô∏è Process timed out (forcing save)...\")\n",
    "\n",
    "elapsed = time.time() - start_time\n",
    "\n",
    "# 3. Locate Evidence\n",
    "epi_files = list(Path('.').glob('*.epi')) + list(Path('.').glob('epi-recordings/*.epi'))\n",
    "\n",
    "if epi_files:\n",
    "    epi_file = max(epi_files, key=lambda p: p.stat().st_mtime)\n",
    "    size_kb = epi_file.stat().st_size / 1024\n",
    "    \n",
    "    print(\"\\n\" + \"=\" * 70)\n",
    "    display(HTML(f'<h2 style=\"color: #10b981;\">‚úÖ RECORDING COMPLETE: {epi_file.name}</h2>'))\n",
    "    print(f\"üì¶ Evidence Size: {size_kb:.2f} KB\")\n",
    "    print(f\"‚è±Ô∏è Duration: {elapsed:.1f}s\")\n",
    "    print(\"=\" * 70)\n",
    "    \n",
    "    # 4. Robust Download\n",
    "    print(\"\\n‚¨áÔ∏è Downloading proof to your machine...\")\n",
    "    try:\n",
    "        from google.colab import files\n",
    "        files.download(str(epi_file))\n",
    "    except Exception as e:\n",
    "        print(f\"   (Auto-download blocked. Use file explorer on left)\")\n",
    "else:\n",
    "    display(HTML('<h2 style=\"color: #ef4444;\">‚ùå Recording Failed</h2>'))\n",
    "    print(\"Debug Output:\")\n",
    "    if 'result' in locals():\n",
    "        print(result.stdout)\n",
    "        print(result.stderr)\n"
]

# ===== FIX 3: VIEWER CELL (High-Fidelity SaaS UI) =====
viewer_source = [
    "# @title üñ•Ô∏è Launch Viewer { display-mode: \"form\" }\n",
    "import zipfile\n",
    "import json\n",
    "import html\n",
    "import os\n",
    "from pathlib import Path\n",
    "from IPython.display import display, HTML\n",
    "\n",
    "# 1. Find the file\n",
    "epi_files = list(Path('.').glob('*.epi')) + list(Path('.').glob('epi-recordings/*.epi'))\n",
    "epi_file = Path(max(epi_files, key=os.path.getmtime)) if epi_files else None\n",
    "\n",
    "print(f\"üîì Decrypting Container: {epi_file}...\")\n",
    "\n",
    "if epi_file and epi_file.exists():\n",
    "    steps = []\n",
    "    signature_id = \"UNKNOWN\"\n",
    "    \n",
    "    try:\n",
    "        with zipfile.ZipFile(epi_file, 'r') as z:\n",
    "            # A. Extract Signature (The Trust Anchor)\n",
    "            if 'manifest.json' in z.namelist():\n",
    "                manifest = json.loads(z.read('manifest.json').decode('utf-8'))\n",
    "                raw_sig = manifest.get('signature', '')\n",
    "                # Format: ed25519:default:BASE64...\n",
    "                if ':' in raw_sig:\n",
    "                    parts = raw_sig.split(':')\n",
    "                    signature_id = f\"{parts[0].upper()}...{parts[-1][:8]}\"\n",
    "            \n",
    "            # B. Extract Data (Prefer Logs for this Agent)\n",
    "            if 'stdout.log' in z.namelist():\n",
    "                logs = z.read('stdout.log').decode('utf-8', errors='ignore')\n",
    "                for line in logs.splitlines():\n",
    "                    # Parse our structured JSON logs\n",
    "                    if line.strip().startswith('{'):\n",
    "                        try:\n",
    "                            j = json.loads(line)\n",
    "                            steps.append(j)\n",
    "                        except:\n",
    "                            pass  # Skip non-json lines\n",
    "                    elif \"---\" in line:\n",
    "                         pass  # Skip separators\n",
    "                    else:\n",
    "                         # Capture raw prints\n",
    "                         steps.append({\"kind\": \"SYSTEM\", \"message\": line, \"timestamp\": \"\"})\n",
    "            \n",
    "    except Exception as e:\n",
    "        print(f\"Read error: {e}\")\n",
    "\n",
    "    # C. BUILD THE \"SAAS\" UI\n",
    "    # We construct a High-Fidelity HTML Dashboard\n",
    "    \n",
    "    # Convert Python data to JS object\n",
    "    js_data = json.dumps(steps)\n",
    "    \n",
    "    viewer_html = f\"\"\"\n",
    "    <!DOCTYPE html>\n",
    "    <html>\n",
    "    <head>\n",
    "        <script src=\"https://cdn.tailwindcss.com\"></script>\n",
    "        <link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap\" rel=\"stylesheet\">\n",
    "        <style>\n",
    "            body {{ font-family: 'Inter', sans-serif; background-color: #f8fafc; }}\n",
    "            .mono {{ font-family: 'JetBrains Mono', monospace; }}\n",
    "            .scrollbar-hide::-webkit-scrollbar {{ display: none; }}\n",
    "        </style>\n",
    "    </head>\n",
    "    <body class=\"p-4\">\n",
    "        <div class=\"max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200\">\n",
    "            \n",
    "            <div class=\"bg-slate-900 p-6 text-white flex justify-between items-center\">\n",
    "                <div>\n",
    "                    <div class=\"flex items-center gap-2\">\n",
    "                        <div class=\"w-3 h-3 rounded-full bg-green-500 animate-pulse\"></div>\n",
    "                        <h1 class=\"text-lg font-bold tracking-wide\">EPI EVIDENCE VIEWER</h1>\n",
    "                    </div>\n",
    "                    <p class=\"text-slate-400 text-xs mt-1\">Immutable Execution Record v2.1.1</p>\n",
    "                </div>\n",
    "                <div class=\"text-right\">\n",
    "                    <div class=\"text-[10px] text-slate-500 font-bold uppercase tracking-wider\">Cryptographic Signature</div>\n",
    "                    <div class=\"mono text-green-400 text-xs bg-slate-800 px-2 py-1 rounded border border-slate-700 mt-1\">\n",
    "                        {signature_id}\n",
    "                    </div>\n",
    "                </div>\n",
    "            </div>\n",
    "\n",
    "            <div class=\"p-0\">\n",
    "                <div class=\"bg-slate-50 border-b border-slate-200 px-6 py-2 text-xs font-bold text-slate-500 uppercase flex justify-between\">\n",
    "                    <span>Timeline</span>\n",
    "                    <span>Event Data</span>\n",
    "                </div>\n",
    "                \n",
    "                <div id=\"feed\" class=\"divide-y divide-slate-100 max-h-[500px] overflow-y-auto\">\n",
    "                    </div>\n",
    "            </div>\n",
    "            \n",
    "             <div class=\"bg-slate-50 p-3 text-center border-t border-slate-200\">\n",
    "                <p class=\"text-xs text-slate-400\">Verified by Evidence Packaged Infrastructure‚Ñ¢</p>\n",
    "            </div>\n",
    "        </div>\n",
    "\n",
    "        <script>\n",
    "            const steps = {js_data};\n",
    "            const container = document.getElementById('feed');\n",
    "            \n",
    "            steps.forEach(step => {{\n",
    "                const kind = step.kind || 'LOG';\n",
    "                const msg = step.message || JSON.stringify(step);\n",
    "                const data = step.data ? JSON.stringify(step.data, null, 2) : null;\n",
    "                const time = step.timestamp ? step.timestamp.split('T')[1].substring(0,12) : '';\n",
    "                \n",
    "                // Styling Logic\n",
    "                let icon = 'üîπ';\n",
    "                let color = 'bg-slate-100 text-slate-600 border-slate-200';\n",
    "                \n",
    "                if(kind.includes('MARKET')) {{ icon = 'üìà'; color = 'bg-blue-50 text-blue-600 border-blue-100'; }}\n",
    "                if(kind.includes('RISK')) {{ icon = 'üõ°Ô∏è'; color = 'bg-orange-50 text-orange-600 border-orange-100'; }}\n",
    "                if(kind.includes('EXECUTION')) {{ icon = 'üöÄ'; color = 'bg-green-50 text-green-600 border-green-100'; }}\n",
    "                if(kind.includes('SYSTEM')) {{ icon = '‚öôÔ∏è'; color = 'bg-gray-50 text-gray-400 border-gray-100'; }}\n",
    "\n",
    "                // Build Card\n",
    "                const div = document.createElement('div');\n",
    "                div.className = 'px-6 py-4 hover:bg-white transition duration-150 flex gap-4 items-start group';\n",
    "                \n",
    "                let dataHtml = '';\n",
    "                if(data) {{\n",
    "                    dataHtml = `<pre class=\"mt-2 text-[10px] bg-slate-800 text-green-400 p-2 rounded mono overflow-x-auto\">${{data}}</pre>`;\n",
    "                }}\n",
    "\n",
    "                div.innerHTML = `\n",
    "                    <div class=\"flex-shrink-0 w-16 text-[10px] text-slate-400 mono pt-1\">${{time}}</div>\n",
    "                    <div class=\"flex-grow\">\n",
    "                        <div class=\"flex items-center gap-2 mb-1\">\n",
    "                            <span class=\"text-lg\">${{icon}}</span>\n",
    "                            <span class=\"text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${{color}}\">${{kind}}</span>\n",
    "                        </div>\n",
    "                        <div class=\"text-sm text-slate-700 font-medium\">${{msg}}</div>\n",
    "                        ${{dataHtml}}\n",
    "                    </div>\n",
    "                `;\n",
    "                container.appendChild(div);\n",
    "            }});\n",
    "        </script>\n",
    "    </body>\n",
    "    </html>\n",
    "    \"\"\"\n",
    "\n",
    "    # Render via IFrame to isolate styles\n",
    "    escaped_html = html.escape(viewer_html)\n",
    "    iframe = f'<iframe srcdoc=\"{escaped_html}\" width=\"100%\" height=\"650\" style=\"border:none; border-radius: 12px;\"></iframe>'\n",
    "    \n",
    "    print(\"‚ú® Rendering Dashboard...\")\n",
    "    display(HTML(iframe))\n",
    "else:\n",
    "    print(\"‚ùå No file found to render.\")\n"
]

# Apply changes
for cell in nb['cells']:
    cid = cell.get('metadata', {}).get('id')
    if cid == 'install':
        cell['source'] = install_source
        print("   ‚úÖ Fixed Cell 1 (Install) - subprocess.check_call")
    elif cid == 'record':
        cell['source'] = record_source
        print("   ‚úÖ Fixed Cell 3 (Record) - subprocess.run with timeout")
    elif cid == 'viewer':
        cell['source'] = viewer_source
        print("   ‚úÖ Fixed Cell 4 (Viewer) - SaaS UI with Tailwind + JS")

with open(NB_PATH, 'w', encoding='utf-8') as f:
    json.dump(nb, f, indent=2, ensure_ascii=False)

print(f"\n‚ú® All investor feedback applied to: {NB_PATH}")
print("\nTRANSFORMATION:")
print("  'Science Project' ‚Üí 'Venture-Scalable Product'")


